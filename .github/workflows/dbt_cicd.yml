# CI/CD Pipeline for dbt Core (Local Execution)
# dbt runs on the GitHub Actions runner, sends SQL to Snowflake
# Triggers on push to main, develop, and pull requests

name: dbt CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  SNOWFLAKE_DATABASE: POSTGRES_REPLICA
  SNOWFLAKE_SCHEMA: DBT_PROJECTS

jobs:
  # ============================================
  # JOB 1: Lint and Validate
  # ============================================
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install SQLFluff
        run: pip install sqlfluff sqlfluff-templater-dbt

      - name: Lint SQL files
        run: |
          sqlfluff lint models/ --dialect snowflake || true
        continue-on-error: true

  # ============================================
  # JOB 2: dbt Build & Test (CI schema)
  # ============================================
  build:
    name: dbt Build & Test
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt
        run: pip install dbt-core dbt-snowflake

      - name: Create profiles.yml for CI
        run: |
          cat << EOF > profiles.yml
          snowflake:
            target: ci
            outputs:
              ci:
                type: snowflake
                account: "${{ secrets.SNOWFLAKE_ACCOUNT }}"
                user: "${{ secrets.SNOWFLAKE_USER }}"
                password: "${{ secrets.SNOWFLAKE_PASSWORD }}"
                role: "${{ secrets.SNOWFLAKE_ROLE }}"
                database: "${{ env.SNOWFLAKE_DATABASE }}"
                warehouse: "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
                schema: "${{ env.SNOWFLAKE_SCHEMA }}_CI"
                threads: 4
          EOF

      - name: Verify dbt connection
        run: dbt debug --profiles-dir .

      - name: Run dbt models
        run: dbt run --profiles-dir .

      - name: Run dbt tests
        run: dbt test --profiles-dir .

  # ============================================
  # JOB 3: Deploy to Production (on push to main)
  # ============================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt
        run: pip install dbt-core dbt-snowflake

      - name: Create profiles.yml for Production
        run: |
          cat << EOF > profiles.yml
          snowflake:
            target: prod
            outputs:
              prod:
                type: snowflake
                account: "${{ secrets.SNOWFLAKE_ACCOUNT }}"
                user: "${{ secrets.SNOWFLAKE_USER }}"
                password: "${{ secrets.SNOWFLAKE_PASSWORD }}"
                role: "${{ secrets.SNOWFLAKE_ROLE }}"
                database: "${{ env.SNOWFLAKE_DATABASE }}"
                warehouse: "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
                schema: "${{ env.SNOWFLAKE_SCHEMA }}_PROD"
                threads: 4
          EOF

      - name: Run dbt models in Production
        run: dbt run --profiles-dir .

      - name: Run dbt tests in Production
        run: dbt test --profiles-dir .
